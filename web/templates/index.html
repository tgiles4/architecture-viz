<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Architecture Viz - Interactive Diagram</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #064e3b;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        
        button {
            padding: 10px 20px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background: #2563eb;
        }
        
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .diagram-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        #diagram {
            width: 100%;
            height: 600px;
            background: #f0fdf4;
        }
        
        .controls {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .search-box {
            flex: 1;
            max-width: 300px;
        }
        
        .search-box input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #6b7280;
        }
        
        #diagram {
            width: 100%;
            height: 600px;
            background: #fafbfc;
        }
        
        .node {
            cursor: pointer;
        }
        
        .node circle {
            stroke: #fff;
            stroke-width: 2px;
        }
        
        .node text {
            font-size: 12px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .link {
            stroke: #999;
            stroke-opacity: 0.6;
            stroke-width: 1px;
        }
        
        .link.import {
            stroke: #3b82f6;
            stroke-dasharray: 3,3;
        }
        
        .link.contains {
            stroke: #10b981;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        /* Overlay styles */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
        }
        
        .overlay-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 8px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 80%;
            max-height: 80%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .overlay-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .overlay-title {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }
        
        .overlay-body {
            flex: 1;
            overflow: auto;
            padding: 20px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #6b7280;
        }
        
        .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .code-block {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 16px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
            overflow-x: auto;
            white-space: pre;
        }
        
        .code-line {
            display: block;
            padding: 2px 0;
        }
        
        .line-number {
            color: #9ca3af;
            margin-right: 16px;
            user-select: none;
        }
        
        .symbol-info {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .symbol-name {
            font-weight: 600;
            color: #0369a1;
            margin-bottom: 8px;
        }
        
        .symbol-details {
            color: #0c4a6e;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèóÔ∏è Architecture Viz</h1>
            <p>Interactive diagram showing packages, modules, and dependencies</p>
            
            <div class="form-group">
                <input type="text" id="pathInput" placeholder="Enter repository path (e.g., /workspaces/architecture-viz)" 
                       value="/workspaces/architecture-viz">
                <button id="analyzeBtn" onclick="analyzeRepository()">Analyze</button>
            </div>
            
            <div id="errorMessage" style="display: none;"></div>
        </div>
        
        <div class="diagram-container">
            <div class="controls">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search nodes..." onkeyup="searchNodes()">
                </div>
                <div class="mode-controls">
                    <button id="modeBtn" onclick="toggleMode()">Architecture View</button>
                    <button id="callgraphBtn" onclick="showCallgraphDialog()" style="display: none;">Show Call Graph</button>
                </div>
                <div class="stats" id="stats">
                    <span>Ready to analyze</span>
                </div>
            </div>
            
            <div id="diagram">
                <div class="loading">Select a repository path and click "Analyze" to visualize the architecture</div>
            </div>
        </div>
    </div>

    <!-- Overlay for code display -->
    <div id="overlay" class="overlay">
        <div class="overlay-content">
            <div class="overlay-header">
                <div class="overlay-title" id="overlayTitle">Code View</div>
                <button class="close-btn" onclick="closeOverlay()">&times;</button>
            </div>
            <div class="overlay-body">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('summary')">Summary</div>
                    <div class="tab" onclick="switchTab('code')">Code</div>
                    <div class="tab" onclick="switchTab('references')">References</div>
                </div>
                
                <div id="summaryTab" class="tab-content active">
                    <div class="symbol-info" id="symbolInfo">
                        <div class="symbol-name" id="symbolName">Module/Class</div>
                        <div class="symbol-details" id="symbolDetails">Details will be loaded here</div>
                    </div>
                </div>
                
                <div id="codeTab" class="tab-content">
                    <div class="code-block" id="codeContent">
                        <div class="loading">Loading code...</div>
                    </div>
                </div>
                
                <div id="referencesTab" class="tab-content">
                    <div id="referencesContent">
                        <div class="loading">Loading references...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Call Graph Dialog -->
    <div id="callgraphDialog" class="overlay" style="display: none;">
        <div class="overlay-content" style="max-width: 600px;">
            <div class="overlay-header">
                <div class="overlay-title">Control Flow Analysis</div>
                <button class="close-btn" onclick="closeCallgraphDialog()">&times;</button>
            </div>
            <div class="overlay-body">
                <div class="form-group">
                    <label for="symbolInput">Enter function/method name:</label>
                    <input type="text" id="symbolInput" placeholder="e.g., analyze, parse_python_module" style="width: 100%; margin-bottom: 10px;">
                </div>
                <div class="form-group">
                    <label for="depthInput">Max depth:</label>
                    <input type="number" id="depthInput" value="3" min="1" max="10" style="width: 80px; margin-right: 20px;">
                    <label>
                        <input type="checkbox" id="includeExternal"> Include external calls
                    </label>
                </div>
                <div class="form-group">
                    <button onclick="generateCallgraph()" style="width: 100%;">Generate Call Graph</button>
                </div>
                <div id="callgraphResults" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <script>
        let data = null;
        let svg = null;
        let simulation = null;
        let nodes = null;
        let links = null;
        let filteredNodes = null;
        let filteredLinks = null;
        let currentAnalysis = null;
        let analysisFiles = null;
        let currentMode = 'architecture'; // 'architecture' or 'callgraph'

        async function analyzeRepository() {
            const path = document.getElementById('pathInput').value.trim();
            const btn = document.getElementById('analyzeBtn');
            const errorDiv = document.getElementById('errorMessage');
            
            if (!path) {
                showError('Please enter a repository path');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Analyzing...';
            errorDiv.style.display = 'none';
            
            try {
                const response = await fetch('/facts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ root_path: path })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                currentAnalysis = path;
                analysisFiles = data.files;  // Store files for source lookup
                updateStats(data.stats);
                renderDiagram(data.nodes, data.edges);
                
            } catch (error) {
                showError(`Analysis failed: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Analyze';
            }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        function updateStats(stats) {
            const statsDiv = document.getElementById('stats');
            statsDiv.innerHTML = `
                <span><strong>${stats.total_files}</strong> files</span>
                <span><strong>${stats.python_files}</strong> Python files</span>
                <span><strong>${stats.modules}</strong> modules</span>
                <span><strong>${stats.packages}</strong> packages</span>
            `;
        }
        
        function renderDiagram(nodes, edges) {
            // Clear previous diagram
            d3.select('#diagram').selectAll('*').remove();
            
            const width = document.getElementById('diagram').clientWidth;
            const height = 600;
            
            svg = d3.select('#diagram')
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            // Create tooltip
            const tooltip = d3.select('body').append('div')
                .attr('class', 'tooltip')
                .style('opacity', 0);
            
            // Create force simulation
            simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(edges).id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(30));
            
            // Create links
            links = svg.append('g')
                .selectAll('line')
                .data(edges)
                .enter().append('line')
                .attr('class', d => `link ${d.type}`)
                .attr('stroke-width', 2);
            
            // Create nodes
            const nodeGroups = svg.append('g')
                .selectAll('g')
                .data(nodes)
                .enter().append('g')
                .attr('class', 'node')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));
            
            // Add circles to nodes
            nodeGroups.append('circle')
                .attr('r', d => d.type === 'package' ? 15 : 10)
                .attr('fill', d => d.type === 'package' ? '#10b981' : '#3b82f6')
                .on('mouseover', function(event, d) {
                    tooltip.transition().duration(200).style('opacity', .9);
                    tooltip.html(`
                        <strong>${d.name}</strong><br>
                        Type: ${d.type}<br>
                        ${d.type === 'module' ? `Classes: ${d.classes}, Functions: ${d.functions}` : `Modules: ${d.modules}`}
                    `)
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    tooltip.transition().duration(500).style('opacity', 0);
                })
                .on('click', function(event, d) {
                    showNodeDetails(d);
                });
            
            // Add labels to nodes
            nodeGroups.append('text')
                .attr('dx', 15)
                .attr('dy', 4)
                .text(d => d.name)
                .style('font-size', '12px')
                .style('fill', '#374151');
            
            // Update positions on simulation tick
            simulation.on('tick', () => {
                links
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
                
                nodeGroups
                    .attr('transform', d => `translate(${d.x},${d.y})`);
            });
            
            // Store references for search
            filteredNodes = nodes;
            filteredLinks = edges;
        }
        
        function searchNodes() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (!data || !searchTerm) {
                // Reset to show all nodes
                if (filteredNodes && filteredLinks) {
                    renderDiagram(filteredNodes, filteredLinks);
                }
                return;
            }
            
            const matchingNodes = data.nodes.filter(node => 
                node.name.toLowerCase().includes(searchTerm) ||
                node.full_name.toLowerCase().includes(searchTerm)
            );
            
            const matchingNodeIds = new Set(matchingNodes.map(n => n.id));
            const matchingLinks = data.edges.filter(link => 
                matchingNodeIds.has(link.source.id || link.source) && 
                matchingNodeIds.has(link.target.id || link.target)
            );
            
            renderDiagram(matchingNodes, matchingLinks);
        }
        
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }
        
        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }
        
        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
        
        // Handle window resize
        window.addEventListener('resize', () => {
            if (data) {
                const width = document.getElementById('diagram').clientWidth;
                svg.attr('width', width);
                simulation.force('center', d3.forceCenter(width / 2, 300));
                simulation.alpha(0.3).restart();
            }
        });
        
        // Overlay functions
        async function showNodeDetails(node) {
            const overlay = document.getElementById('overlay');
            const title = document.getElementById('overlayTitle');
            const symbolName = document.getElementById('symbolName');
            const symbolDetails = document.getElementById('symbolDetails');
            
            title.textContent = `${node.name} (${node.type})`;
            symbolName.textContent = node.name;
            
            if (node.type === 'module') {
                symbolDetails.innerHTML = `
                    <strong>Module:</strong> ${node.full_name}<br>
                    <strong>Classes:</strong> ${node.classes}<br>
                    <strong>Functions:</strong> ${node.functions}<br>
                    <strong>Imports:</strong> ${node.imports}
                `;
            } else {
                symbolDetails.innerHTML = `
                    <strong>Package:</strong> ${node.full_name}<br>
                    <strong>Modules:</strong> ${node.modules}
                `;
            }
            
            // Load code content
            await loadCodeContent(node);
            
            overlay.style.display = 'block';
        }
        
        async function loadCodeContent(node) {
            const codeContent = document.getElementById('codeContent');
            const referencesContent = document.getElementById('referencesContent');
            
            try {
                // Find the file path for this module
                let filePath = null;
                if (node.type === 'module' && analysisFiles) {
                    // Find the file path from stored analysis data
                    for (const file of analysisFiles) {
                        if (file.module === node.full_name) {
                            filePath = file.path;
                            break;
                        }
                    }
                }
                
                if (filePath) {
                    // Load source code
                    const sourceResponse = await fetch(`/source?path=${encodeURIComponent(filePath)}`);
                    const sourceData = await sourceResponse.json();
                    
                    // Display code with line numbers
                    const lines = sourceData.content.split('\n');
                    const codeHtml = lines.map((line, i) => 
                        `<div class="code-line">
                            <span class="line-number">${sourceData.start_line + i}</span>${escapeHtml(line)}
                        </div>`
                    ).join('');
                    
                    codeContent.innerHTML = codeHtml;
                } else {
                    codeContent.innerHTML = '<div class="loading">No source code available for this node</div>';
                }
                
                // Load references
                if (node.type === 'module') {
                    const references = data.edges.filter(edge => 
                        edge.source === node.id || edge.target === node.id
                    );
                    
                    referencesContent.innerHTML = `
                        <h4>Dependencies</h4>
                        <ul>
                            ${references.map(ref => `<li>${ref.source} ‚Üí ${ref.target} (${ref.type})</li>`).join('')}
                        </ul>
                    `;
                } else {
                    referencesContent.innerHTML = '<div class="loading">No references available for packages</div>';
                }
                
            } catch (error) {
                codeContent.innerHTML = `<div class="error">Error loading code: ${error.message}</div>`;
                referencesContent.innerHTML = `<div class="error">Error loading references: ${error.message}</div>`;
            }
        }
        
        function closeOverlay() {
            document.getElementById('overlay').style.display = 'none';
        }
        
        function switchTab(tabName) {
            // Remove active class from all tabs and contents
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Close overlay when clicking outside
        document.getElementById('overlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeOverlay();
            }
        });
        
        // Call graph functions
        function toggleMode() {
            const modeBtn = document.getElementById('modeBtn');
            const callgraphBtn = document.getElementById('callgraphBtn');
            
            if (currentMode === 'architecture') {
                currentMode = 'callgraph';
                modeBtn.textContent = 'Call Graph View';
                callgraphBtn.style.display = 'inline-block';
            } else {
                currentMode = 'architecture';
                modeBtn.textContent = 'Architecture View';
                callgraphBtn.style.display = 'none';
                // Restore original diagram
                if (data) {
                    renderDiagram(data.nodes, data.edges);
                }
            }
        }
        
        function showCallgraphDialog() {
            document.getElementById('callgraphDialog').style.display = 'block';
        }
        
        function closeCallgraphDialog() {
            document.getElementById('callgraphDialog').style.display = 'none';
        }
        
        async function generateCallgraph() {
            const symbol = document.getElementById('symbolInput').value.trim();
            const depth = parseInt(document.getElementById('depthInput').value);
            const includeExternal = document.getElementById('includeExternal').checked;
            const resultsDiv = document.getElementById('callgraphResults');
            
            if (!symbol) {
                resultsDiv.innerHTML = '<div class="error">Please enter a function name</div>';
                return;
            }
            
            if (!currentAnalysis) {
                resultsDiv.innerHTML = '<div class="error">Please run analysis first</div>';
                return;
            }
            
            try {
                const response = await fetch(`/callgraph?symbol=${encodeURIComponent(symbol)}&root_path=${encodeURIComponent(currentAnalysis)}&max_depth=${depth}&include_external=${includeExternal}`);
                const callgraphData = await response.json();
                
                if (callgraphData.nodes && callgraphData.nodes.length > 0) {
                    // Render call graph in the main diagram
                    renderCallgraph(callgraphData.nodes, callgraphData.edges);
                    
                    // Show results summary
                    resultsDiv.innerHTML = `
                        <div class="symbol-info">
                            <strong>Call Graph for: ${symbol}</strong><br>
                            Found ${callgraphData.total_reachable} reachable functions<br>
                            Max depth: ${depth}
                        </div>
                    `;
                    
                    closeCallgraphDialog();
                } else {
                    resultsDiv.innerHTML = '<div class="error">No call graph found for this symbol</div>';
                }
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">Error generating call graph: ${error.message}</div>`;
            }
        }
        
        function renderCallgraph(nodes, edges) {
            // Clear previous diagram
            d3.select('#diagram').selectAll('*').remove();
            
            const width = document.getElementById('diagram').clientWidth;
            const height = 600;
            
            svg = d3.select('#diagram')
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            // Create force simulation for call graph
            simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(edges).id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(30));
            
            // Create links
            links = svg.append('g')
                .selectAll('line')
                .data(edges)
                .enter().append('line')
                .attr('class', 'link call')
                .attr('stroke', '#ef4444')
                .attr('stroke-width', 2)
                .attr('marker-end', 'url(#arrowhead)');
            
            // Add arrow marker
            svg.append('defs').append('marker')
                .attr('id', 'arrowhead')
                .attr('viewBox', '0 -5 10 10')
                .attr('refX', 8)
                .attr('refY', 0)
                .attr('markerWidth', 6)
                .attr('markerHeight', 6)
                .attr('orient', 'auto')
                .append('path')
                .attr('d', 'M0,-5L10,0L0,5')
                .attr('fill', '#ef4444');
            
            // Create nodes
            const nodeGroups = svg.append('g')
                .selectAll('g')
                .data(nodes)
                .enter().append('g')
                .attr('class', 'node')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));
            
            // Add circles to nodes with depth-based coloring
            nodeGroups.append('circle')
                .attr('r', d => d.depth === 0 ? 12 : 8)
                .attr('fill', d => {
                    if (d.depth === 0) return '#dc2626'; // Red for entry point
                    if (d.type === 'method') return '#7c3aed'; // Purple for methods
                    return '#3b82f6'; // Blue for functions
                })
                .attr('stroke', '#fff')
                .attr('stroke-width', 2);
            
            // Add labels
            nodeGroups.append('text')
                .attr('dx', 15)
                .attr('dy', 4)
                .text(d => d.name)
                .style('font-size', '12px')
                .style('fill', '#374151');
            
            // Add depth indicators
            nodeGroups.append('text')
                .attr('dx', 15)
                .attr('dy', 18)
                .text(d => `d${d.depth}`)
                .style('font-size', '10px')
                .style('fill', '#9ca3af');
            
            // Update positions on simulation tick
            simulation.on('tick', () => {
                links
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
                
                nodeGroups
                    .attr('transform', d => `translate(${d.x},${d.y})`);
            });
        }
    </script>
</body>
</html>
